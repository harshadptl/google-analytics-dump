/*
analytics-dump - v - 2013-11-02
Dumps analytics from google into a csv
Lovingly coded by Jess Frazelle  - http://frazelledazzell.com/ 
*/
function handleClientLoad(){gapi.client.setApiKey(apiKey),window.setTimeout(checkAuth,1)}function checkAuth(){gapi.auth.authorize({client_id:clientId,scope:scopes,immediate:!0},handleAuthResult)}function handleAuthResult(a){a?gapi.client.load("analytics","v3",handleAuthorized):handleUnauthorized()}function handleAuthorized(){var a=document.getElementById("authorize-button"),b=document.getElementById("make-api-call-button");a.style.display="none",b.style.display="block",b.onclick=makeApiCall,outputToPage("Click the Get Data button to begin.")}function handleUnauthorized(){var a=document.getElementById("authorize-button"),b=document.getElementById("make-api-call-button");b.style.display="none",a.style.display="block",a.onclick=handleAuthClick,outputToPage("Please authorize this script to access Google Analytics.")}function handleAuthClick(){return gapi.auth.authorize({client_id:clientId,scope:scopes,immediate:!1},handleAuthResult),!1}function makeApiCall(){outputToPage("Querying Accounts."),gapi.client.analytics.management.accounts.list().execute(handleAccounts)}function handleAccounts(a){if(a.code)updatePage("There was an error querying accounts: "+a.message);else if(a&&a.items&&a.items.length)for(var b=0;b<a.items.length;b++){var c=a.items[b].id;queryWebproperties(c,b)}else updatePage("No accounts found for this user.")}function queryWebproperties(a,b){setTimeout(function(){updatePage("Querying Webproperties."),gapi.client.analytics.management.webproperties.list({accountId:a}).execute(handleWebproperties)},5e3*b)}function handleWebproperties(a){if(a.code)updatePage("There was an error querying webproperties: "+a.message);else if(a&&a.items&&a.items.length)for(var b=0;b<a.items.length;b++){var c=a.items[b].accountId,d=a.items[b].id;queryProfiles(c,d,b)}else updatePage("No webproperties found for this user.")}function queryProfiles(a,b,c){setTimeout(function(){updatePage("Querying Profiles."),gapi.client.analytics.management.profiles.list({accountId:a,webPropertyId:b}).execute(handleProfiles)},5e3*c)}function handleProfiles(a){if(a.code)updatePage("There was an error querying profiles: "+a.message);else if(a&&a.items&&a.items.length)for(var b=0;b<a.items.length;b++){var c=a.items[b].id;queryCoreReportingApi(c)}else updatePage("No profiles found for this user.")}function queryCoreReportingApi(a){updatePage("Querying Core Reporting API."),gapi.client.analytics.data.ga.get({ids:"ga:"+a,"start-date":lastNDays(14),"end-date":lastNDays(0),metrics:"ga:visits",dimensions:"ga:source,ga:keyword",sort:"-ga:visits,ga:source",filters:"ga:medium==organic","max-results":25}).execute(handleCoreReportingResults)}function handleCoreReportingResults(a){if(a.code)updatePage("There was an error querying core reporting API: "+a.message);else if(a.rows&&a.rows.length){if(resultsToPage("Adding Results for Profile Name: "+a.profileInfo.profileName+"...<br>"),!headersDone){output.push("<table>"),output.push("<tr>"),output.push("<th>Profile Name</th>");for(var b,c=0;b=a.columnHeaders[c];++c)output.push("<th>",b.name,"</th>");headersDone=!0,output.push("</tr>")}for(var d,c=0;d=a.rows[c];++c)output.push("<tr><td>"+a.profileInfo.profileName+"</td><td>",d.join("</td><td>"),"</td></tr>");resultsToPage(output.join(""))}else outputToPage("No results found.")}function outputToPage(a){document.getElementById("output").innerHTML=a}function resultsToPage(a){document.getElementById("output").innerHTML="",document.getElementById("results").innerHTML=a+"</table>"}function updatePage(a){document.getElementById("output").innerHTML+="<br>"+a}function lastNDays(a){var b=new Date,c=new Date;c.setDate(b.getDate()-a);var d=c.getFullYear(),e=c.getMonth()+1;10>e&&(e="0"+e);var f=c.getDate();return 10>f&&(f="0"+f),[d,e,f].join("-")}var clientId="1008856934158.apps.googleusercontent.com",apiKey="AIzaSyC9IVFnVPB5_1X7uUXq90UvJUYeJSHmNiU",scopes="https://www.googleapis.com/auth/analytics.readonly",headersDone=!1,output=[];